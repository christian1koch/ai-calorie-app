generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model ConsumedProduct {
  id             Int      @id @default(autoincrement())
  name           String   @unique
  aliases        String   @default("")
  searchText     String
  kcalPer100g    Float
  proteinPer100g Float
  carbsPer100g   Float
  fatPer100g     Float
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([searchText])
}

model MealEntry {
  id               Int      @id @default(autoincrement())
  mealId           Int?
  intent           String   @default("log_meal")
  rawText          String
  item             String
  amountGrams      Float?
  kcal             Float?
  proteinG         Float?
  carbsG           Float?
  fatG             Float?
  source           String
  confidence       String
  assumptions      String
  assumptionsJson  String   @default("[]")
  provenanceJson   String   @default("{}")
  lookupSourceType String?
  lookupLabel      String?
  lookupUrl        String?
  agentModel       String?
  confidenceScore  Float?
  deletedAt        DateTime?
  berlinDate       String
  berlinTime       String
  timezone         String   @default("Europe/Berlin")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  meal             Meal?    @relation(fields: [mealId], references: [id], onDelete: SetNull)
  revisions        EntryRevision[]

  @@index([berlinDate])
  @@index([mealId])
  @@index([deletedAt])
}

model Meal {
  id         Int        @id @default(autoincrement())
  rawText    String
  label      String
  kcal       Float?
  proteinG   Float?
  carbsG     Float?
  fatG       Float?
  confidence String
  assumptions String
  berlinDate String
  berlinTime String
  timezone   String     @default("Europe/Berlin")
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  entries    MealEntry[]
  sessions   ConversationSession[]
  actions    MealAction[]

  @@index([berlinDate])
}

model ConversationSession {
  id           Int      @id @default(autoincrement())
  sessionId    String   @unique
  activeMealId Int?
  lastIntent   String?
  metadataJson String   @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  activeMeal   Meal?    @relation(fields: [activeMealId], references: [id], onDelete: SetNull)
}

model MealAction {
  id             Int      @id @default(autoincrement())
  sessionId      String?
  mealId         Int?
  actionType     String
  status         String
  rawText        String
  resolvedIntent String
  reason         String?
  entryIdsJson   String   @default("[]")
  createdAt      DateTime @default(now())
  meal           Meal?    @relation(fields: [mealId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([mealId])
  @@index([createdAt])
}

model EntryRevision {
  id         Int      @id @default(autoincrement())
  entryId    Int
  actor      String
  reason     String
  beforeJson String
  afterJson  String
  createdAt  DateTime @default(now())
  entry      MealEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  @@index([entryId])
  @@index([createdAt])
}
